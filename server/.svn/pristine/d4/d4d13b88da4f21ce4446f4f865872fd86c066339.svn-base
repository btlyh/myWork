package com.cambrian.dfhm.instancing.logic;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;
import com.cambrian.common.net.DataAccessException;
import com.cambrian.common.object.Sample;
import com.cambrian.common.util.TimeKit;
import com.cambrian.dfhm.Lang;
import com.cambrian.dfhm.battle.BattleCard;
import com.cambrian.dfhm.battle.BattleScene;
import com.cambrian.dfhm.common.Player;
import com.cambrian.dfhm.instancing.entity.ActiveNPC;
import com.cambrian.dfhm.instancing.entity.AttRecord;
import com.cambrian.dfhm.instancing.entity.CrossNPC;
import com.cambrian.dfhm.instancing.entity.HardNPC;
import com.cambrian.dfhm.instancing.entity.Instancing;
import com.cambrian.dfhm.instancing.entity.NPC;
import com.cambrian.dfhm.instancing.entity.NormalNPC;

/**
 * 类说明：副本管理器
 * 
 * @author：LazyBear
 */
public class InstancingManager
{

	/* static fields */
	private static InstancingManager instance=new InstancingManager();

	/* static methods */
	public static InstancingManager getInstance()
	{
		return instance;
	}

	/* fields */

	/* constructors */

	/* properties */

	/* init start */

	/* methods */

	/** 进入活动副本 */
	public ArrayList<Integer> enterInstancing()
	{
		Instancing activeInstancing=(Instancing)Sample.getFactory()
			.getSample(Instancing.ACTIVE_INSTANCING_SID);
		String error=checkEnterInstancing(activeInstancing);
		if(error!=null)
		{
			new DataAccessException(601,error);
		}

		int[] NPCSids=activeInstancing.getArrayNPC();

		ArrayList<Integer> openActiveNPC=new ArrayList<Integer>();

		ActiveNPC npc=null;
		for(int i=0;i<NPCSids.length;i++)
		{
			npc=(ActiveNPC)Sample.factory.getSample(NPCSids[i]);

			if(npc.getOpenDay()==TimeKit.getDayOfWeek())
			{
				openActiveNPC.add(npc.getSid());
			}
		}
		return openActiveNPC;
	}
	/** 检查进入活动副本 */
	public String checkEnterInstancing(Instancing activeInstancing)
	{
		if(activeInstancing==null)
		{
			return Lang.F1408;
		}
		return null;
	}
	/** 攻击NPC */
	public synchronized ArrayList<Integer> attackNPC(int sid,Player player,
		int npcType,int attType)
	{
		Map<String,Object> resultMap=checkAttackNPC(sid,player,npcType);
		String error=(String)resultMap.get("error");
		if(error!=null)
		{
			throw new DataAccessException(601,error);
		}
		NPC npc=null;
		switch(npcType)
		{
			case NPC.NORMAL:
				npc=(NormalNPC)resultMap.get("npc");
				break;
			case NPC.HARD:
				npc=(HardNPC)resultMap.get("npc");
				break;
			case NPC.CROSS:
				npc=(CrossNPC)resultMap.get("npc");
				break;
			case NPC.ACTIVITY:
				npc=(ActiveNPC)resultMap.get("npc");
				break;
			default:
				break;
		}
		BattleScene scene=new BattleScene();
		scene.setCurRound(1);
		scene.setMaxRound(npc.getRound());
		boolean fightResult=scene.start(player,npc,npcType);
		scene.getRecord().set(0,scene.getStep());
		player.decrToken(npc.getNeedToken());
		if(fightResult)
		{
			npc.handleForWin(player);
		}
		npc.handleForAtt(player);
		return scene.getRecord();
	}

	/** 检查攻击NPC */
	private Map<String,Object> checkAttackNPC(int sid,Player player,
		int npcType)
	{
		if(npcType>NPC.ACTIVITY||npcType<NPC.NORMAL)
		{
			throw new DataAccessException(601,Lang.F1409);
		}
		Map<String,Object> resultMap=new HashMap<String,Object>();
		if(player.getCurToken()<1)
		{
			resultMap.put("error",Lang.F1403);
			return resultMap;
		}
		NPC npc=null;
		switch(npcType)
		{
			case NPC.NORMAL:
				npc=(NormalNPC)Sample.getFactory().getSample(sid);
				break;
			case NPC.HARD:
				npc=(HardNPC)Sample.getFactory().getSample(sid);
				break;
			case NPC.CROSS:
				npc=(CrossNPC)Sample.getFactory().getSample(sid);
				break;
			case NPC.ACTIVITY:
				npc=(ActiveNPC)Sample.getFactory().getSample(sid);
				break;
			default:
				break;
		}
		if(npc==null)
		{
			resultMap.put("error",Lang.F1401);
			return resultMap;
		}
		if(player.getCurToken()<npc.getNeedToken())
		{
			resultMap.put("error",Lang.F1404);
			return resultMap;
		}
		ArrayList<AttRecord> attRecords=player.getAttRecords();
		AttRecord checkRecord=null;
		if(attRecords!=null&&attRecords.size()>0)
		{
			for(AttRecord attRecord:attRecords)
			{
				if(attRecord.getSidNPC()==npc.getSid())
				{
					checkRecord=attRecord;
				}
			}
		}
		String error=npc.checkAttNpc(player,checkRecord);
		resultMap.put("error",error);
		resultMap.put("npc",npc);
		return resultMap;
	}

}
