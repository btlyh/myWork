package com.cambrian.dfhm.timer;

import com.cambrian.common.net.DataAccessException;
import com.cambrian.common.timer.TimerCenter;
import com.cambrian.common.timer.TimerEvent;
import com.cambrian.common.timer.TimerListener;
import com.cambrian.dfhm.Lang;
import com.cambrian.dfhm.common.Player;
import com.cambrian.game.Session;
import com.cambrian.game.SessionMap;
import com.cambrian.game.ds.DataServer;

/**
 * 类说明：军令定时器，用于恢复军令
 * 
 * @author：LazyBear
 * 
 */
public class TokenTimer implements TimerListener 
{
	
	/* static fields */
	/** 恢复时间 默认现在30分钟*/
	public static int TOKENADDTIME = 1000*60*30;
	/** 恢复数量*/
	public static int TOKENADDNUM = 1;
	/* static methods */

	/* fields */
	/** 数据服务器 */
	DataServer dataServer;
	/** 恢复军令定时器事件*/
	TimerEvent tokenTimeEvent;
	/* constructors */
	public TokenTimer()
	{
		this.tokenTimeEvent = new TimerEvent(this,"tokenTimeEvevt", TOKENADDTIME);
	}
	
	/* properties */
	public void setDataServer(DataServer dataServer)
	{
		this.dataServer=dataServer;
	}
	/* init start */

	/* methods */
	public void onTimer(TimerEvent e) 
	{
		if(!e.getParameter().equals("tokenTimeEvevt")) return;
		addTokenOnTime();
	}
	
	/**
	 * 开启定时器
	 */
	public void timerStart()
	{
		TimerCenter.getInstance();
		TimerCenter.getMillisTimer().add(tokenTimeEvent);
	} 
	
	/**
	 * 开始恢复军令
	 */
	private void addTokenOnTime()
	{
		SessionMap sm = this.dataServer.getSessionMap();
		Session[] sessions = sm.getSessions();
		for(int i = 0;i<sessions.length;i++)
		{
			Player player = (Player)sessions[i].getSource();
			if (player == null) 
			{
				throw new DataAccessException(601, Lang.F9000_SDE);
			}
			synchronized (player) 
			{
				player.incrToken(TOKENADDNUM);
			}
		}
	}
}
